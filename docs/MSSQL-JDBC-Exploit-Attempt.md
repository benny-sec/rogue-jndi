# MS SQL JDBC Exploit Attempt

## Overview
Attempted to exploit the MS SQL JDBC driver's socket factory initialization to achieve remote code execution through malicious class loading.

## Approach
The MS SQL JDBC driver supports two parameters in its connection string:
- `socketFactoryClass`: Specifies a custom socket factory class
- `socketFactoryConstructorArg`: Argument passed to the socket factory constructor

The idea was to use these parameters to:
1. Load a malicious class (e.g., Spring's ClassPathXmlApplicationContext)
2. Pass a URL to load malicious XML
3. Execute arbitrary code through XML bean instantiation

## Why It Failed

### Type Check Limitation
The MS SQL JDBC driver enforces strict type checking in `Util.newInstance`:

```java
static <T> T newInstance(Class<?> returnType, String className, String constructorArg, Object[] msgArgs) throws ... {
    Class<?> clazz = Class.forName(className);
    if (!returnType.isAssignableFrom(clazz)) {
        throw new IllegalArgumentException("Class must be assignable to SocketFactory");
    }
    // ... constructor invocation
}
```

Key limitations:
1. The specified class MUST extend `javax.net.SocketFactory`
2. The constructor must accept a String parameter
3. The class must be available in the classpath
4. The class must be instantiable

### Attempted Workarounds
1. Direct Class Loading:
   - Tried using `ClassPathXmlApplicationContext` directly
   - Failed due to type check

2. Custom SocketFactory:
   - Created a custom class extending `SocketFactory`
   - Works but requires custom code on target
      - If we can get custom code on target, we already have code execution
      - Makes this vector redundant as we'd have better ways to achieve RCE

3. Alternative Properties:
   - Explored other connection properties
   - None provide code execution capabilities
   - All have similar type checking limitations

## Conclusion
The MS SQL JDBC driver's strict type checking effectively prevents remote code execution through socket factory initialization. The requirement that the socket factory class must extend `javax.net.SocketFactory` makes it impossible to load arbitrary classes for code execution.

## References
1. [Added connection properties to specify custom SocketFactory](https://github.com/microsoft/mssql-jdbc/pull/1217)
2. [Exploiting deserialization vulnerabilities in Java 17 and beyond, using JDBC connections](https://mogwailabs.de/en/blog/2023/04/look-mama-no-templatesimpl/)
3. [Make JDBC Attacks Brilliant Again II](https://pyn3rd.github.io/2022/06/02/Make-JDBC-Attacks-Brilliant-Again/) 